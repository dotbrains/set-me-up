name: Tests

on: [push, pull_request]

jobs:
  test:
    name: Test on ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
      fail-fast: false

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test bash syntax for setup.sh
        run: |
          echo "Testing bash syntax..."
          if bash -n setup.sh; then
            echo "✓ Valid syntax: setup.sh"
          else
            echo "✗ Syntax error in: setup.sh"
            exit 1
          fi

      - name: Test setup.sh in dry-run mode
        run: |
          echo "Testing setup.sh execution in test environment..."
          
          # Create a temporary directory for testing
          TEST_DIR=$(mktemp -d)
          cd "$TEST_DIR"
          
          # Copy setup.sh to test directory
          cp "$GITHUB_WORKSPACE/setup.sh" .
          
          echo "Test directory: $TEST_DIR"
          
          # Verify git is available
          if command -v git &> /dev/null; then
            echo "✓ Git is installed"
            git --version
          else
            echo "✗ Git is not installed"
            exit 1
          fi
          
          echo "✓ Setup script prerequisites met"

      - name: Test setup.sh idempotency
        run: |
          echo "Testing idempotency (checking directory existence logic)..."
          
          # Create a temporary directory
          TEST_DIR=$(mktemp -d)
          cd "$TEST_DIR"
          
          # Copy setup.sh
          cp "$GITHUB_WORKSPACE/setup.sh" .
          
          # Create a mock directory to test the skip logic
          mkdir -p blueprint
          
          # Extract and test just the clone_repo function logic
          bash -c '
            source <(grep -A 10 "clone_repo()" '"$GITHUB_WORKSPACE/setup.sh"')
            
            # Test that it properly detects existing directories
            if clone_repo "https://example.com/test.git" "blueprint" 2>&1 | grep -q "already exists"; then
              echo "✓ Idempotency check works correctly"
            else
              echo "✗ Idempotency check failed"
              exit 1
            fi
          '

      - name: Verify file structure
        run: |
          echo "Checking repository structure..."
          
          # Check for essential files
          [ -f "README.md" ] && echo "✓ README.md found" || { echo "✗ README.md not found"; exit 1; }
          [ -f "setup.sh" ] && echo "✓ setup.sh found" || { echo "✗ setup.sh not found"; exit 1; }
          [ -f ".gitignore" ] && echo "✓ .gitignore found" || { echo "✗ .gitignore not found"; exit 1; }
          [ -x "setup.sh" ] && echo "✓ setup.sh is executable" || { echo "✗ setup.sh is not executable"; exit 1; }

      - name: Verify .gitignore entries
        run: |
          echo "Checking .gitignore configuration..."
          
          REQUIRED_IGNORES=("blueprint/" "docs/" "home/" "installer/" "modules/" "utilities/")
          
          for entry in "${REQUIRED_IGNORES[@]}"; do
            if grep -q "^$entry$" .gitignore; then
              echo "✓ $entry is in .gitignore"
            else
              echo "✗ $entry is missing from .gitignore"
              exit 1
            fi
          done

      - name: Test README.md structure
        run: |
          echo "Validating README.md content..."
          
          # Check for key sections
          grep -q "Quick Setup" README.md && echo "✓ Quick Setup section exists" || { echo "✗ Quick Setup section missing"; exit 1; }
          grep -q "Directory Structure" README.md && echo "✓ Directory Structure section exists" || { echo "✗ Directory Structure section missing"; exit 1; }
          grep -q "Repositories" README.md && echo "✓ Repositories section exists" || { echo "✗ Repositories section missing"; exit 1; }

      - name: Generate test report
        if: always()
        run: |
          echo "## Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **OS**: ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Shell**: $(bash --version | head -n 1)" >> $GITHUB_STEP_SUMMARY
          echo "- **Git**: $(git --version)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✓ All tests passed successfully" >> $GITHUB_STEP_SUMMARY
