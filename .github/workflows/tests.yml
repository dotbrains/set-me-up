name: Tests

on: [push, pull_request]

jobs:
  test:
    name: Test on ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
      fail-fast: false

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test bash syntax for scripts
        run: |
          echo "Testing bash syntax..."
          if bash -n scripts/setup.sh && bash -n scripts/update.sh; then
            echo "✓ Valid syntax: scripts/setup.sh"
            echo "✓ Valid syntax: scripts/update.sh"
          else
            echo "✗ Syntax error in scripts"
            exit 1
          fi

      - name: Test scripts in dry-run mode
        run: |
          echo "Testing scripts execution in test environment..."
          
          # Create a temporary directory for testing
          TEST_DIR=$(mktemp -d)
          cd "$TEST_DIR"
          
          # Copy scripts to test directory
          cp -r "$GITHUB_WORKSPACE/scripts" .
          
          echo "Test directory: $TEST_DIR"
          
          # Verify git is available
          if command -v git &> /dev/null; then
            echo "✓ Git is installed"
            git --version
          else
            echo "✗ Git is not installed"
            exit 1
          fi
          
          echo "✓ Setup script prerequisites met"

      - name: Test setup.sh idempotency
        run: |
          echo "Testing idempotency (checking directory existence logic)..."
          
          # Create a temporary directory
          TEST_DIR=$(mktemp -d)
          cd "$TEST_DIR"
          
          # Copy scripts
          cp -r "$GITHUB_WORKSPACE/scripts" .
          
          # Create a mock directory to test the skip logic
          mkdir -p blueprint
          
          # Test the idempotency by checking if script detects existing directory
          # Extract the clone_repo function from setup.sh
          sed -n '/^clone_repo()/,/^}/p' "$GITHUB_WORKSPACE/scripts/setup.sh" > clone_test.sh
          
          # Create a test script that sources the function
          cat > test_idempotency.sh << 'EOF'
          #!/bin/bash
          source ./clone_test.sh
          clone_repo "https://example.com/test.git" "blueprint"
          EOF
          
          chmod +x test_idempotency.sh
          
          # Run the test and check output
          if ./test_idempotency.sh 2>&1 | grep -q "already exists"; then
            echo "✓ Idempotency check works correctly"
          else
            echo "✗ Idempotency check failed"
            exit 1
          fi

      - name: Verify file structure
        run: |
          echo "Checking repository structure..."
          
          # Check for essential files
          [ -f "README.md" ] && echo "✓ README.md found" || { echo "✗ README.md not found"; exit 1; }
          [ -f "scripts/setup.sh" ] && echo "✓ scripts/setup.sh found" || { echo "✗ scripts/setup.sh not found"; exit 1; }
          [ -f "scripts/update.sh" ] && echo "✓ scripts/update.sh found" || { echo "✗ scripts/update.sh not found"; exit 1; }
          [ -f "scripts/repos.txt" ] && echo "✓ scripts/repos.txt found" || { echo "✗ scripts/repos.txt not found"; exit 1; }
          [ -f ".gitignore" ] && echo "✓ .gitignore found" || { echo "✗ .gitignore not found"; exit 1; }
          [ -x "scripts/setup.sh" ] && echo "✓ scripts/setup.sh is executable" || { echo "✗ scripts/setup.sh is not executable"; exit 1; }
          [ -x "scripts/update.sh" ] && echo "✓ scripts/update.sh is executable" || { echo "✗ scripts/update.sh is not executable"; exit 1; }

      - name: Verify .gitignore entries
        run: |
          echo "Checking .gitignore configuration..."
          
          REQUIRED_IGNORES=("blueprint/" "docs/" "home/" "installer/" "modules/" "utilities/")
          
          for entry in "${REQUIRED_IGNORES[@]}"; do
            if grep -q "^$entry$" .gitignore; then
              echo "✓ $entry is in .gitignore"
            else
              echo "✗ $entry is missing from .gitignore"
              exit 1
            fi
          done

      - name: Test README.md structure
        run: |
          echo "Validating README.md content..."
          
          # Check for key sections
          grep -q "Quick Setup" README.md && echo "✓ Quick Setup section exists" || { echo "✗ Quick Setup section missing"; exit 1; }
          grep -q "Directory Structure" README.md && echo "✓ Directory Structure section exists" || { echo "✗ Directory Structure section missing"; exit 1; }
          grep -q "Repositories" README.md && echo "✓ Repositories section exists" || { echo "✗ Repositories section missing"; exit 1; }

      - name: Generate test report
        if: always()
        run: |
          echo "## Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **OS**: ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Shell**: $(bash --version | head -n 1)" >> $GITHUB_STEP_SUMMARY
          echo "- **Git**: $(git --version)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✓ All tests passed successfully" >> $GITHUB_STEP_SUMMARY
